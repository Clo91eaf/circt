//===- RTGOps.cpp - Implement the RTG operations --------------------------===//
//
// Part of the LLVM Project, under the Apache License v2.0 with LLVM Exceptions.
// See https://llvm.org/LICENSE.txt for license information.
// SPDX-License-Identifier: Apache-2.0 WITH LLVM-exception
//
//===----------------------------------------------------------------------===//
//
// This file implements the RTG ops.
//
//===----------------------------------------------------------------------===//

#include "circt/Dialect/RTG/IR/RTGOps.h"
#include "mlir/IR/Builders.h"
#include "mlir/IR/DialectImplementation.h"
#include <numeric>

using namespace mlir;
using namespace circt;
using namespace rtg;

//===----------------------------------------------------------------------===//
// LabelDeclOp
//===----------------------------------------------------------------------===//

APInt LabelDeclOp::getBinary() {
  assert(false && "must not be used for label resources");
  return APInt();
}

void LabelDeclOp::printAssembly(llvm::raw_ostream &stream) {
  // TODO: perform substitutions
  stream << getFormatString();
}

//===----------------------------------------------------------------------===//
// SequenceOp
//===----------------------------------------------------------------------===//

LogicalResult SequenceOp::verifyRegions() {
  if (getBody()->getArgumentTypes() != getResult().getType().getArgTypes())
    return emitOpError("argument types must match sequence type");

  return success();
}

//===----------------------------------------------------------------------===//
// SelectRandomOp
//===----------------------------------------------------------------------===//

LogicalResult SelectRandomOp::verify() {
  if (getSequences().size() != getSequenceArgs().size())
    return emitOpError("number of sequences and sequence arg lists must match");

  if (getSequences().size() != getRatios().size())
    return emitOpError("number of sequences and ratios must match");

  for (auto [seq, args] : llvm::zip(getSequences(), getSequenceArgs()))
    if (TypeRange(cast<SequenceType>(seq.getType()).getArgTypes()) !=
        args.getTypes())
      return emitOpError(
          "sequence argument types do not match sequence requirements");

  return success();
}

//===----------------------------------------------------------------------===//
// SetCreateOp
//===----------------------------------------------------------------------===//

ParseResult SetCreateOp::parse(OpAsmParser &parser, OperationState &result) {
  llvm::SmallVector<OpAsmParser::UnresolvedOperand, 16> operands;
  Type elemType;

  if (parser.parseOperandList(operands) ||
      parser.parseOptionalAttrDict(result.attributes) || parser.parseColon() ||
      parser.parseType(elemType))
    return failure();

  result.addTypes({SetType::get(result.getContext(), elemType)});

  for (auto operand : operands)
    if (parser.resolveOperand(operand, elemType, result.operands))
      return failure();
  return success();
}

void SetCreateOp::print(OpAsmPrinter &p) {
  p << " ";
  p.printOperands(getElements());
  p.printOptionalAttrDict((*this)->getAttrs());
  p << " : " << getSet().getType().getElementType();
}

LogicalResult SetCreateOp::verify() {
  if (getElements().size() > 0)
    if (getElements()[0].getType() != getSet().getType().getElementType())
      return emitOpError() << "operand types must match set element type";

  return success();
}

//===----------------------------------------------------------------------===//
// TestOp
//===----------------------------------------------------------------------===//

LogicalResult TestOp::verifyRegions() {
  if (getBody()->getArgumentTypes() != getTargetType().getEntryTypes())
    return emitOpError("argument types must match target entry types");

  return success();
}

//===----------------------------------------------------------------------===//
// TargetOp
//===----------------------------------------------------------------------===//

LogicalResult TargetOp::verifyRegions() {
  if (getBody()->getTerminator()->getOperandTypes() !=
      getTargetType().getEntryTypes())
    return emitOpError(
        "terminator operand types must match target entry types");

  return success();
}

//===----------------------------------------------------------------------===//
// TableGen generated logic.
//===----------------------------------------------------------------------===//

// Provide the autogenerated implementation guts for the Op classes.
#include "circt/Dialect/RTG/IR/RTGInterfaces.cpp.inc"

#define GET_OP_CLASSES
#include "circt/Dialect/RTG/IR/RTG.cpp.inc"
